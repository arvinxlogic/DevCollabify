const { SendEmailCommand } = require("@aws-sdk/client-ses");
const { sesClient } = require("./sesClient.js");

const createSendEmailCommand = (toAddress, fromAddress, subject, body) => {
  return new SendEmailCommand({
    Destination: {
      CcAddresses: [],
      ToAddresses: [toAddress],
    },
    Message: {
      Body: {
        Html: {
          Charset: "UTF-8",
          Data: `
            <html>
              <body>
                <h2>${subject}</h2>
                <div style="background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px;">
                  ${body}
                </div>
                <hr>
                <p style="color: #666; font-size: 12px;">
                  This email was sent from ConnectDev Platform
                </p>
              </body>
            </html>
          `,
        },
        Text: {
          Charset: "UTF-8",
          Data: `${subject}\n\n${body}\n\n---\nThis email was sent from ConnectDev Platform`,
        },
      },
      Subject: {
        Charset: "UTF-8",
        Data: subject || "ConnectDev Notification",
      },
    },
    Source: fromAddress,
    ReplyToAddresses: [],
  });
};

const run = async (toEmailId, subject = "Connection Request Update", body = "Your connection request has been updated") => {
  console.log("📧 Sending email to:", toEmailId);
  console.log("📧 Subject:", subject);
  
  // 🔥 PRODUCTION MODE: Send to actual recipient
  const sendEmailCommand = createSendEmailCommand(
    toEmailId,                      // TO: Actual recipient email
    "arvind@connectdev.online",     // FROM: Your verified domain
    subject,
    body
  );

  try {
    const result = await sesClient.send(sendEmailCommand);
    console.log("✅ Email sent successfully! Message ID:", result.MessageId);
    return { success: true, messageId: result.MessageId };
  } catch (caught) {
    console.error("❌ Email sending failed:", caught.message);
    return { success: false, error: caught.message };
  }
};

module.exports = { run };